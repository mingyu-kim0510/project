<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" >
  <title>User</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://hangeul.pstatic.net/hangeul_static/css/nanum-square.css">
  <script src="//code.jquery.com/jquery-3.3.1.min.js"></script>
  <style>
    body {
      font-family: 'NanumSquareExtraBold';
    }
  </style>
</head>
<body>

<h2 style="font-size: 2.0rem" class="col mb-5 mt-5 fw-bold text-center">마이페이지</h2>
<!-- 메인 시작 -->
<div class="container my-5" style="transform: rotate(0.04deg)">&nbsp;</div>
<div class="container container-fluid my-5 text-center" style="transform: rotate(0.04deg)">
  <div class="row">
    <div class="col mb-4">
      <img src="/img/person-circle.svg" style="width: 12rem;" alt="person-circle" />
    </div>
  </div>

  <div class="row">
    <div class="col mb-5 fw-bold">
      <a style="font-size:2rem" id="userName" th:text="${username}">&nbsp;</a>
    </div>
  </div>
<div style="transform: rotate(0.04deg)">[[${test}]]</div>
  <div class="row ms-3 me-3" style="transform: rotate(0.04deg)">
    <div class="col-6">
      <button type="button" class="btn btn-secondary btn-lg w-100 fw-bold" style="background-color: #FFB7B1; border: none;"
              onclick="location.href='/likelist'">찜한 음식점</button>
    </div>

    <div class="col-6">
      <button type="button" id="modifyBtn" class="btn btn-secondary btn-lg w-100 fw-bold" style="background-color: #FFB7B1; border: none" data-bs-toggle="modal" data-bs-target="#staticBackdrop">정보 수정</button>
    </div>


    <div class="col-12 mt-3">
      <button type="button" id="logoutBtn" class="btn btn-secondary btn-lg w-100 fw-bold" style="background-color: #C2C2C2; border: none;" onclick="location.href='/logout'">로그아웃</button>
    </div>
  </div>
</div>
<!-- 메인 끝 -->

<!-- 모달 시작 -->
<div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
  <div class="modal-dialog" style="margin-top:9rem">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5 fw-bold" id="staticBackdropLabel">유저 아이디 변경</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body fw-bold pb-3">
        <h6 id="alert" class="ms-1 mb-3" style="color:black">아이디를 변경해주세요</h6>
        <div class="form-floating">
          <input type="text" class="form-control" name="modalUserName" id="modalUserName" placeholder="아이디를 입력하세요" />
          <label for="modalUserName" id="modalUserNameLabel">아이디 입력</label>
        </div>
      </div>
      <div class="modal-footer">
        <div class="row w-100">
          <div class="col-6" style="padding-left:0; padding-right:5px">
            <button type="button" class="btn btn-secondary w-100 fw-bold" style="border: none" data-bs-dismiss="modal">취소</button>
          </div>
          <div class="col-6" style="padding-left:5px; padding-right:0">
            <button type="button" class="btn btn-primary w-100 fw-bold" style="background-color: #FFB7B1; border: none" data-bs-dismiss="modal" id="saveBtn">저장</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div id="menuBar"></div>
<script src="/js/menuBar.js"></script>
<!-- 모달 끝 -->
<script src="/js/fetcher.js"></script>
</body>
<script>
  const userName = document.getElementById('userName');
  const modifyBtn = document.getElementById('modifyBtn');
  const saveBtn = document.getElementById('saveBtn');
  const modalUserName = document.getElementById('modalUserName');
  const alert = document.getElementById('alert');

// 정보수정 창 열기
  modifyBtn.addEventListener('click', () => {
    modalUserName.value = userName.innerHTML;
    setTimeout(() => {modalUserName.focus()}, 600);
  });

  // 유저명 변경
  modalUserName.addEventListener('blur', () => checkID(false));
  modalUserName.addEventListener('keydown', (event) => {
    if (event.key === 'Enter') {
      checkID(true);
    }
  })
  saveBtn.addEventListener('click', () => checkID(true));
  async function checkID (check) {
    // id값 가져오기
    const userId = modalUserName.value;
    // 중복검사
    const result = await postFetcher('/id-check', {userId})

    // 아이디 검사
    if (modalUserName.value.length < 3) {
      alert.innerHTML = '3글자 이상 입력해 주세요';
      alert.style.color = 'red';
    } else if (modalUserName.value === userName.innerHTML) {
      alert.innerHTML = '아이디를 변경해주세요';
      alert.style.color = 'red';
    } else if (result) {
      alert.innerHTML = '사용 가능한 아이디 입니다';
      alert.style.color = 'blue';
      if (check) {
        // 아이디 변경 전송
        fetch('/modify', { method: 'post', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userId })})
          .then(res => {
            userName.innerHTML = modalUserName.value;
            $('#staticBackdrop').modal('hide');
          });
      }
    } else {
      alert.innerHTML = '사용 중인 아이디 입니다';
      alert.style.color = 'red';
    }
  }


</script>
</html>