<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" >
    <title>Main</title>
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9"
            crossorigin="anonymous"
    />
    <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
            crossorigin="anonymous">
    </script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://hangeul.pstatic.net/hangeul_static/css/nanum-square.css">
    <script src="//code.jquery.com/jquery-3.3.1.min.js"></script>
    <style>
        @font-face {
            font-family: 'YClover-Bold';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_231029@1.1/YClover-Bold.woff2') format('woff2');
            font-weight: 700;
            font-style: normal;
        }
        body {
            font-family: 'NanumSquareExtraBold';
        }
        #header {
            background-color: #FFB7B1 !important;
            height: 4rem;
        }
        #header h1 {
            font-family: 'YClover-Bold', sans-serif; /* Apply the custom font to the h2 element */
            /* Additional styling for the h2 element within the header */
            color: #343434;
            line-height: 2rem;
            margin: 0 0 0 0.5rem;
        }
        .button-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 2열로 배치 */
            gap: 5px;
            overflow-x: auto;
        }
        .button {
            text-align: center;
            padding-top: 5px;
            border: none;
            cursor: pointer;
            text-decoration: none;
        }
        /* 스크롤바 숨김 */
        .button-container::-webkit-scrollbar {
            display: none;
        }
        .button-container2 {
            display: flex;
            margin-left: .75rem;
            margin-right: .75rem;
            overflow-x: auto; /* 수평 스크롤 유지 */
            scroll-snap-type: x mandatory; /* 스크롤 스냅 설정 */
        }
        .button2 {
            flex: 0 0 calc(45% - .375rem); /* 3개씩 보이도록 너비 조정 */
            text-align: left;
            padding:  .1875rem;
            margin-left: .1875rem;
            margin-right: .1875rem;
            border: none;
            cursor: pointer;
            text-decoration: none;
            scroll-snap-align: start; /* 스크롤 정렬 설정 */
            position: relative;
            transform: rotate(0.04deg);
        }
        .button2::before {
            content: "";
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            border-radius: 5px; /* 테두리 모서리 둥글게 설정 */
        }
        /* 스크롤바 숨김 */
        .button-container2::-webkit-scrollbar {
            display: none;
        }

    </style>
</head>
<body>
<nav id="header" class="navbar bg-body-tertiary">
    <div class="align-items: center" style="display: flex; align-items: center; margin-left:auto; margin-right:auto">
        <img style="width: 2.2rem; display: block;" src="/img/apple-touch-icon.png" class="d=block" alt="">
        <h1 style="font-size: 1.7rem; color: #3b3b3b; line-height: 2rem; margin: 0 0 0 0.5rem;"> &nbsp추천해조</h1>
    </div>
</nav>
<div style="margin-left:1.125rem; margin-right:1rem; padding-top: 1rem; padding-bottom: 1rem; background-color: white; border-radius: .375rem;">
    <div class="row justify-content-between" style="align-items: center;">
        <div class="col-12" style="padding-left:1.1rem">
            <h1 style="font-size: calc(50vh / 20)">실시간 예상 혼잡도</h1>
        </div>
    </div>
    <div class="row">
        <div class="col-auto" style="margin:0; margin-left:1.125rem; padding:0">
            <button type="button" class="btn btn-outline-primary" id="timeBtn" style="display: flex; transform: rotate(0.04deg)" data-no=0>
                <div style="font-size: calc(100vw / 25); margin:0">기준 시간 : </div>
                <div style="margin:0; font-size: calc(100vw / 25); transform: rotate(0.04deg)" id="timeInput"> -</div>
            </button>
        </div>
    </div>
</div>

<div style="background-color: #f2f2f2; padding-top: 1rem; padding-bottom: 1rem">
    <div class="container">
        <div>
            <h5 style="margin-left:.75rem;">여유 지역</h5>
        </div>
        <div class="button-container2" style="padding-top: 0.5rem; padding-bottom:.5rem;  margin-top: auto; margin-bottom: auto" id="safeList">
            <div style="margin-left:1.2rem; height: 6.7rem">
                <div class="spinner-border text-secondary" style="" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>

        <div class="mt-3">
            <h5 style="margin-left:.75rem;">혼잡 지역</h5>
        </div>
        <div class="button-container2" style="padding-top: 0.5rem; padding-bottom:.5rem; margin-top: auto; margin-bottom: auto" id="warnList">
            <div class="spinner-border text-secondary" style="margin-left:1.2rem; margin-top:2.5rem; margin-bottom:1rem" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>
</div>
<div class="mt-3">
    <h3 style="margin-left: 30px">카테고리</h3>
</div>
<div class="container-fluid">
    <div class="button-container mt-2">
        <a class='button' href="api/map/한식">
            <img style="height: 2.5rem" src="/img/porridge.png" alt="한식"/>
            <h1 style= "font-weight: bold; font-size: 1rem; margin-top: 1rem; color: black;">한식</h1>
        </a>
        <a class='button' href="api/map/중식">
            <img style="height: 2.5rem" src="/img/dimsum.png" alt="중식"/>
            <h1 style="font-weight: bold; font-size: 1rem; margin-top: 1rem; color: black;">중식</h1>
        </a>
        <a class='button' href="api/map/일식">
            <img style="height: 2.5rem" src="/img/sushi.png" alt="일식"/>
            <h1 style="font-weight: bold; font-size: 1rem; margin-top: 1rem; color: black;">일식</h1>
        </a>
        <a class='button mt-1' href="api/map/서양식">
            <img style="height: 2.5rem" src="/img/pizza.png" alt="양식"/>
            <h1 style="font-weight: bold; font-size: 1rem; margin-top: 1rem; color: black;">양식</h1>
        </a>
        <a class='button mt-1' href="api/map/아시아">
            <img style="height: 2.5rem" src="/img/sauce.png" alt="아시안"/>
            <h1 style="font-weight: bold; font-size: 1rem; margin-top: 1rem; color: black;">아시안</h1>
        </a>
        <a class='button mt-1' href="api/map/디저트">
            <img style="height: 2.5rem" src="/img/dessert.png" alt="디저트"/>
            <h1 style="font-weight: bold; font-size: 1rem; margin-top: 1rem; color: black;">디저트</h1>
        </a>
    </div>
</div>
<!-- Modal -->
<div class="modal fade" id="myModal" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="margin-left:auto; margin-right:auto; max-width:20rem">
        <div class="modal-content">
            <div class="modal-body"  style="margin-left:auto; margin-right:auto; max-width:18rem" >
                <div id="modalBody">

                </div>
                <div style="margin-left:15%; margin-right:15%; transform: rotate(.04deg)">
                    <button type="button" class="btn btn-warning w-100 mb-3" onclick="location.href = '/api/district/'+ modalBody.children[0].innerText">지도로 보기</button>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="menuBar"></div>
<script src="/js/menuBar.js"></script>
<script src="/js/fetcher.js"></script>
</body>
<script>
    const safeList = document.getElementById('safeList');
    const timeBtn = document.getElementById('timeBtn');
    const warnList = document.getElementById('warnList');
    const timeInput = document.getElementById('timeInput');
    const modalBody = document.getElementById('modalBody');
    function loader() {
        return `
                <div style="margin-left:1.2rem; height: ${document.querySelector('.predictLists').clientHeight}px; margin-top: auto; margin-bottom: auto">
                    <div class="spinner-border text-secondary" style="" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>`
    }
    var fetchResult = '', newArr = [];
    window.onload = async () => {
        fetchResult = await postFetcher('/api/getPredictAll', {});
        predictRender(0);
    }

    function predictRender(predictTime) {
        let arr = [], safeAndNormal = [], warnAndDanger = [];
        arr = fetchResult
            .filter((item) => item.storeCount > 0)
            .sort((a, b) => a.predictTime.localeCompare(b.predictTime));
        safeList.innerHTML = '';
        warnList.innerHTML = '';
        newArr = [arr.slice(0, 28),arr.slice(28, 56),arr.slice(56, 84),arr.slice(84, 113)]

        safeAndNormal = newArr[predictTime]
            .filter((item) => item.predictCongestion === '여유' || item.predictCongestion === '보통')
            .sort((a, b) => b.storeCount - a.storeCount);
        safeAndNormal.forEach((item,i) => {
            let color = '';
            if(item.predictCongestion === '여유') color = '#1960ef'
            else color = '#7db249'
            safeList.innerHTML += addList(color, item.districtName, item.storeCount, i+1);
        });

        warnAndDanger = newArr[predictTime]
            .filter((item) => item.predictCongestion === '약간 붐빔' || item.predictCongestion === '붐빔')
            .sort((a, b) => b.storeCount - a.storeCount);
        warnAndDanger.forEach((item,i) => {
            let color = '';
            if(item.predictCongestion === '약간 붐빔') color = '#fd9f28'
            else color = '#fc5230'
            warnList.innerHTML += addList(color, item.districtName, item.storeCount, i+1);
        });
        if(safeAndNormal.length === 0) {
            safeList.innerHTML = `<div style="height:6.7rem"><div style="margin-left: .75rem; transform:rotate(0.04deg)">예상 여유 지역이 없어요!</div></div>`
        }
        if(warnAndDanger.length === 0) {
            warnList.innerHTML = `<div style="height:6.7rem"><div style="margin-left: .75rem; transform:rotate(0.04deg)">예상 혼잡 지역이 없어요!</div></div>`
        }

        timeInput.innerHTML = newArr[predictTime][0].predictTime.substring(11,17);
    }

    timeBtn.addEventListener('click', () => {
        const timeCount = parseInt(timeBtn.dataset.no);
        if(timeCount !== 3) {
            safeList.innerHTML = loader();
            warnList.innerHTML = loader();
            timeBtn.dataset.no = timeCount + 1;
            setTimeout(() => {predictRender(timeBtn.dataset.no)}, 100);

        } else {
            safeList.innerHTML = loader();
            warnList.innerHTML = loader();
            timeBtn.dataset.no = 0;
            setTimeout(() => {predictRender(0)}, 100);
        }
    });
    function addList(color, district, storeCount) {
        return `
    <div class="predictLists card rounded button2 shadow-sm" onclick="graphRender(this)" data-name="${district}">
      <div class="card-body" style="text-overflow: ellipsis">
        <div class="card-title" style="text-overflow: ellipsis; overflow: hidden; white-space: nowrap;">${district}</div>
        <button class="btn" style="margin-left:auto; margin-top:.375rem; background-color:${color}; color: white;">${storeCount}곳</button>
      </div>
    </div>
        `;
    }

    function graphRender(element) {
        const timeResult = [
            newArr[0].filter(i => i.districtName === element.dataset.name)[0].predictTime.substring(11,13) + "시",
            newArr[1].filter(i => i.districtName === element.dataset.name)[0].predictTime.substring(11,13) + "시",
            newArr[2].filter(i => i.districtName === element.dataset.name)[0].predictTime.substring(11,13) + "시",
            newArr[3].filter(i => i.districtName === element.dataset.name)[0].predictTime.substring(11,13) + "시",
        ]
        const congestionResult = [
            newArr[0].filter(i => i.districtName === element.dataset.name)[0].predictCongestion,
            newArr[1].filter(i => i.districtName === element.dataset.name)[0].predictCongestion,
            newArr[2].filter(i => i.districtName === element.dataset.name)[0].predictCongestion,
            newArr[3].filter(i => i.districtName === element.dataset.name)[0].predictCongestion,
        ]
        let graph = ``, time = ``;
        congestionResult.forEach(item => {
            if(item === '여유') {
                graph += `<div class="col-auto ms-1 me-1" style="margin-top:auto"><div style="width:1.5rem; height: 3rem; background-color:#1960ef; border-radius: 1rem; margin-top:auto"></div></div>`
            }
            else if(item === '보통') {
                graph += `<div class="col-auto  ms-1 me-1" style="margin-top:auto"><div style="width:1.5rem; height: 4.5rem; background-color:#7db249; border-radius: 1rem; margin-top:auto;"></div></div>`
            }
            else if(item === '약간 붐빔') {
                graph += `<div class="col-auto  ms-1 me-1" style="margin-top:auto"><div style="width:1.5rem; height: 6rem; background-color:#fd9f28; border-radius: 1rem; margin-top:auto;"></div></div>`
            }
            else if(item === '붐빔') {
                graph += `<div class="col-auto  ms-1 me-1" style="margin-top:auto"><div style="width:1.5rem; height: 7.5rem; background-color:#fc5230; border-radius: 1rem; margin-top:auto;"></div></div>`
            }
        })
        timeResult.forEach(item => {
            time += `<div class="col-auto" style="padding-left:0; padding-right:0;width:3.5rem !important; text-align:center" style="margin-top:auto">${item}</div>`

        })
        modalBody.innerHTML = `
            <h5 class="ms-3 mt-3 mb-4">
                ${element.dataset.name}
            </h5>
            <div class="row justify-content-center mt-3" style="margin-left:auto; margin-right:auto; height: 7.5rem">
                ${graph}
            </div>
            <div class="row justify-content-center my-3" style="margin-left:auto; margin-right:auto">
                ${time}
            </div>
        `
        $('#myModal').modal('show');


    }
</script>
</html>