<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Main</title>
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9"
            crossorigin="anonymous"
    />
    <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
            crossorigin="anonymous">
    </script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://hangeul.pstatic.net/hangeul_static/css/nanum-square.css">
    <style>
        body {
            font-family: 'NanumSquareExtraBold';
        }
        #header {
            background-color: #FFB7B1 !important;
            height: 3.7rem;
        }
        .button-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 2열로 배치 */
            gap: 5px;
            overflow-x: auto;
        }
        .button {
            text-align: center;
            padding-top: 5px;
            border: none;
            cursor: pointer;
            text-decoration: none;
        }
        /* 스크롤바 숨김 */
        .button-container::-webkit-scrollbar {
            display: none;
        }
        .button-container2 {
            display: flex;
            margin-left: 1.5rem;
            margin-right: 1.5rem;
            overflow-x: auto; /* 수평 스크롤 유지 */
            scroll-snap-type: x mandatory; /* 스크롤 스냅 설정 */
        }
        .button2 {
            flex: 0 0 calc(40% - .375rem); /* 3개씩 보이도록 너비 조정 */
            text-align: left;
            padding:  .1875rem;
            margin-left: .1875rem;
            margin-right: .1875rem;
            border: none;
            cursor: pointer;
            text-decoration: none;
            scroll-snap-align: start; /* 스크롤 정렬 설정 */
            position: relative;
            transform: rotate(0.04deg);
        }
        .button2::before {
            content: "";
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            border-radius: 5px; /* 테두리 모서리 둥글게 설정 */
        }
        /* 스크롤바 숨김 */
        .button-container2::-webkit-scrollbar {
            display: none;
        }
        .button-container h1 {
            font-family: 'NanumSquareBold';
        }
        .mt-2 h5 {
            font-family: 'Nanum SquareBold';
        }
    </style>
</head>
<body>
<nav id="header" class="navbar bg-body-tertiary" style="height:8rem">
    <div style="display: flex; align-items: center; margin-left: auto; margin-right: auto">
        <img style="height: 2rem; display: block;" src="/img/smile.svg"class="d=block" alt="">
        <h2 style="color: #343434; line-height: 2rem; margin: 0 0 0 0.5rem; font-style:oblique; text-align: center">추천해조</h2>
    </div>
</nav>




<div class="container" style="margin-top:2.5rem">
    <div class="row justify-content-between">
        <div class="col-auto">
            <h3 style="margin-left: 1.5rem">실시간 예상 혼잡도</h3>
        </div>
        <div class="col-auto">
            <h6 style="margin-right: 1.5rem; transform: rotate(0.04deg)" id="timeInput"> -</h6>
        </div>
    </div>
</div>
<div class="container">
    <div class="mt-4">
        <h5 style="margin-left:1.875rem">여유 지역</h5>
    </div>
    <div class="button-container2" style="padding-top: 0.5rem; padding-bottom:.5rem" id="safeList">
        <div style="margin-left:1.5rem; height: 6.7rem">
            <div class="spinner-border text-secondary" style="" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <h5 style="margin-left:1.875rem">혼잡 지역</h5>
    </div>
    <div class="button-container2" style="padding-top: 0.5rem; padding-bottom:.5rem; margin-bottom: 3.7rem" id="warnList">
        <div class="spinner-border text-secondary" style="margin-left:1.5rem; margin-top:2.5rem; margin-bottom:2rem" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
</div>
<div class="mt-4">
    <h3 style="margin-left: 30px">카테고리</h3>
</div>
<div class="container-fluid" style="margin-bottom: 4.5rem">
    <div class="button-container mt-3">
        <a class='button' href="api/map/한식">
            <img style="height: 3rem" src="/img/porridge.png" alt="한식"/>
            <h1 style= "font-weight: bold; font-size: 1.1rem; margin-top: 1rem; color: black;">한식</h1>
        </a>
        <a class='button' href="api/map/중식">
            <img style="height: 3rem" src="/img/dimsum.png" alt="중식"/>
            <h1 style="font-weight: bold; font-size: 1.1rem; margin-top: 1rem; color: black;">중식</h1>
        </a>
        <a class='button' href="api/map/일식">
            <img style="height: 3rem" src="/img/sushi.png" alt="일식"/>
            <h1 style="font-weight: bold; font-size: 1.1rem; margin-top: 1rem; color: black;">일식</h1>
        </a>
        <a class='button' href="api/map/서양식">
            <img style="height: 3rem" src="/img/pizza.png" alt="양식"/>
            <h1 style="font-weight: bold; font-size: 1.1rem; margin-top: 1rem; color: black;">양식</h1>
        </a>
        <a class='button' href="api/map/아시아">
            <img style="height: 3rem" src="/img/sauce.png" alt="아시안"/>
            <h1 style="font-weight: bold; font-size: 1.1rem; margin-top: 1rem; color: black;">아시안</h1>
        </a>
        <a class='button' href="api/map/디저트">
            <img style="height: 3rem" src="/img/dessert.png" alt="디저트"/>
            <h1 style="font-weight: bold; font-size: 1.1rem; margin-top: 1rem; color: black;">디저트</h1>
        </a>
    </div>
</div>
<div id="menuBar"></div>
<script src="/js/menuBar.js"></script>
<script src="/js/fetcher.js"></script>
</body>
<script>
    const safeList = document.getElementById('safeList');
    const warnList = document.getElementById('warnList');
    const timeInput = document.getElementById('timeInput');
    var fetchResult = '';
    window.onload = async () => {
        fetchResult = await postFetcher('/api/getPredictAll', {});
        predictRender();
    }

    function predictRender() {
        let arr = [], newArr = [], safeAndNormal = [], warnAndDanger = [];
        arr = fetchResult
            .filter((item) => item.storeCount > 0)
            .sort((a, b) => a.predictTime.localeCompare(b.predictTime));
        safeList.innerHTML = '';
        warnList.innerHTML = '';
        newArr = arr.slice(0, 28);

        safeAndNormal = newArr
            .filter((item) => item.predictCongestion === '여유' || item.predictCongestion === '보통')
            .sort((a, b) => b.storeCount - a.storeCount);
        safeAndNormal.forEach((item,i) => {
            let color = '';
            if(item.predictCongestion === '여유') color = '#1960ef'
            else color = '#7db249'
            safeList.innerHTML += addList(color, item.districtName, item.storeCount, i+1);
        });

        warnAndDanger = newArr
            .filter((item) => item.predictCongestion === '약간 붐빔' || item.predictCongestion === '붐빔')
            .sort((a, b) => b.storeCount - a.storeCount);
        warnAndDanger.forEach((item,i) => {
            let color = '';
            if(item.predictCongestion === '약간 붐빔') color = '#fd9f28'
            else color = '#fc5230'
            warnList.innerHTML += addList(color, item.districtName, item.storeCount, i+1);
        });
        if(safeAndNormal.length === 0) {
            safeList.innerHTML = `<div style="height:6.7rem"><div style="margin-left: .75rem; transform:rotate(0.04deg)">예상 여유 지역이 없어요!</div></div>`
        }
        if(warnAndDanger.length === 0) {
            warnList.innerHTML = `<div style="height:6.7rem"><div style="margin-left: .75rem; transform:rotate(0.04deg)">예상 혼잡 지역이 없어요!</div></div>`
        }
        console.log(safeAndNormal);
        console.log(warnAndDanger);

        timeInput.innerHTML = newArr[0].predictTime.substring(11,17);
    }
    function addList(color, district, storeCount) {
        return `
    <div class="card rounded button2 shadow-sm" onclick="clickList(this)" data-name="${district}">
      <div class="card-body" style="text-overflow: ellipsis">
        <div class="card-title" style="text-overflow: ellipsis; overflow: hidden; white-space: nowrap">${district}</div>
        <button class="btn" style="margin-left:auto; background-color:${color}; color: white">${storeCount}곳</button>
      </div>
    </div>
        `;
    }

    function clickList(element) {
        console.log(element.dataset.name);
        location.href = "api/district/" + element.dataset.name;
    }
</script>
</html>
