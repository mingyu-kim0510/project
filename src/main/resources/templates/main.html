<!DOCTYPE html>
<html lang="en">
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=452c7ddc8ed8a9dd0f1f2a182fe1303f"></script>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9"
            crossorigin="anonymous"
    />
    <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
            crossorigin="anonymous"
    ></script>
</head>
<body>
<!-- 검색 -->
<div class="container container-fluid mt-3 mb-3">
    <div class="row g-2">
        <div class="col col-8">
            <input type="text" id="searchVal" class="form-control" />
        </div>
        <div class="col col-4">
            <button id="fetchBtn" type="button" class="w-100 btn btn-primary mb-3" data-bs-toggle="offcanvas" data-bs-target="#offcanvasExample" aria-controls="offcanvasExample">검색</button>
        </div>
    </div>
    <div id="map" style="width:100%;height:800px;"></div>
</div>
<!-- 지도 -->


<!-- 검색결과 (오프캔버스 하단) -->
<div class="offcanvas offcanvas-bottom" tabindex="-1" id="offcanvasExample" aria-labelledby="offcanvasExampleLabel" style="height:60%">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasExampleLabel">검색 결과</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <div id="innerList">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <!-- 오프캔버스 내용 -->
        </div>
    </div>
</div>
</body>
<script>
    const fetchBtn = document.getElementById('fetchBtn');
    const searchVal = document.getElementById('searchVal');
    fetchBtn.addEventListener('click', async () => {
        // request
        const response = await fetch('/api/store/list', {
            method:'post',
            headers: {
                'Content-Type':'application/json'
            },
            body: JSON.stringify({
                searchVal : searchVal.value
            })
        });
        const result = await response.json();

        // 지도 내용 초기화
        var mapContainer = document.getElementById('map') // 지도를 표시할 div
        mapContainer.innerHTML = '';
        //// 핀 위치, 중심좌표 지정
        var positions = [
        ];
        let latMean = 0;
        let lngMean = 0;
        result.forEach(item => {
            positions.push({
                title: item.storeName,
                latlng: new kakao.maps.LatLng(parseFloat(item.storeLon), parseFloat(item.storeLat))
            })
            console.log(item.storeLon)
            latMean += parseFloat(item.storeLon);
            lngMean += parseFloat(item.storeLat);
        })
        latMean = latMean /positions.length;
        lngMean = lngMean /positions.length;

        console.log(latMean)
        console.log(lngMean)

        var mapOption = {
            center: new kakao.maps.LatLng(latMean, lngMean), // 지도의 중심좌표
            level: 7 // 지도의 확대 레벨
        };

        var map = new kakao.maps.Map(mapContainer, mapOption); // 지도를 생성합니다



        // 마커 이미지의 이미지 주소입니다
        var imageSrc = "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png";

        for (var i = 0; i < positions.length; i ++) {

            // 마커 이미지의 이미지 크기 입니다
            var imageSize = new kakao.maps.Size(24, 35);

            // 마커 이미지를 생성합니다
            var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize);

            // 마커를 생성합니다
            var marker = new kakao.maps.Marker({
                map: map, // 마커를 표시할 지도
                position: positions[i].latlng, // 마커를 표시할 위치
                title : positions[i].title, // 마커의 타이틀, 마커에 마우스를 올리면 타이틀이 표시됩니다
                image : markerImage // 마커 이미지
            });
        }

        // 검색결과 출력
        const storeList = document.getElementById('innerList');
        storeList.innerHTML = ''
        result.forEach(item => {
            storeList.innerHTML += `
            <div class="card mb-3" data-no="${item.storeIdx}">
                <div class="card-header">
                    ${item.storeName}
                </div>
                <div class="card-body">
                    <blockquote class="blockquote mb-0">
                        <p style="font-size:1rem">${item.storeNewAddr}</p>
                    </blockquote>
                </div>
            </div>
            `
        })
    });
</script>
</html>